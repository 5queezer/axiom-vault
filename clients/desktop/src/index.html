<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AxiomVault</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* macOS Dark Mode System Colors */
            --mac-bg-main: #1e1e1e;
            --mac-bg-sidebar: #2d2d2d;
            --mac-border: #454545;
            --mac-blue: #0a84ff;
            --mac-blue-dim: rgba(10, 132, 255, 0.2);
            --mac-text: #ffffff;
            --mac-text-secondary: #98989d;
            --mac-selected: #0a84ff;
            --mac-button-bg: rgba(255, 255, 255, 0.1);
            --mac-button-hover: rgba(255, 255, 255, 0.15);
            --radius-s: 5px;
            --radius-m: 10px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }

        body {
            font-family: var(--font-stack);
            background-color: var(--mac-bg-main);
            color: var(--mac-text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 13px;
        }

        /* --- Window Drag Region --- */
        .titlebar-drag-region {
            height: 28px;
            width: 100%;
            position: absolute;
            top: 0; left: 0;
            -webkit-app-region: drag;
            z-index: 1000;
        }

        .main-container { display: flex; flex: 1; height: 100vh; }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px;
            background-color: var(--mac-bg-sidebar);
            backdrop-filter: blur(20px);
            border-right: 1px solid #000;
            display: flex;
            flex-direction: column;
            padding-top: 38px;
        }

        .sidebar-section { padding: 0 10px; margin-bottom: 20px; }
        .sidebar-header {
            color: var(--mac-text-secondary);
            font-size: 11px;
            font-weight: 700;
            padding: 8px 10px;
            margin-bottom: 4px;
        }

        .vault-item {
            display: flex; align-items: center;
            padding: 6px 10px;
            border-radius: var(--radius-s);
            cursor: default;
            color: #dfdfdf;
            margin-bottom: 2px;
        }
        .vault-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .vault-item.active { background-color: var(--mac-selected); color: white; }
        .vault-item i { margin-right: 8px; opacity: 0.8; width: 16px; text-align: center; }

        .vault-status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            margin-left: auto;
            border: 2px solid var(--mac-text-secondary);
        }
        .vault-item.active .vault-status-dot { border-color: rgba(255,255,255,0.5); }
        .vault-status-dot.mounted { background: #30d158; border: none; }

        .sidebar-footer {
            margin-top: auto; padding: 10px;
            border-top: 1px solid rgba(0,0,0,0.2);
            display: flex; gap: 8px;
        }

        .icon-btn {
            background: transparent; border: none;
            color: var(--mac-text-secondary);
            padding: 6px; border-radius: 4px;
            cursor: pointer; flex: 1; transition: color 0.2s;
        }
        .icon-btn:hover { color: var(--mac-text); background: rgba(255,255,255,0.05); }

        /* --- Content --- */
        .content { flex: 1; display: flex; flex-direction: column; background: var(--mac-bg-main); }

        .toolbar {
            height: 52px;
            border-bottom: 1px solid var(--mac-border);
            display: flex; align-items: center;
            padding: 10px 20px 0 20px;
            justify-content: space-between;
        }

        .toolbar-title { font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .toolbar-actions { display: flex; gap: 12px; }

        .tool-btn {
            background: var(--mac-button-bg);
            border: 0.5px solid rgba(0,0,0,0.2);
            color: var(--mac-text);
            border-radius: 6px; padding: 4px 10px;
            font-size: 12px; font-weight: 500;
            cursor: pointer; display: flex; align-items: center; gap: 6px;
        }
        .tool-btn:hover { background: var(--mac-button-hover); }
        .tool-btn:active { background: rgba(255,255,255,0.2); }

        .path-bar {
            background: var(--mac-bg-main);
            border-bottom: 1px solid var(--mac-border);
            padding: 6px 20px; font-size: 12px;
            color: var(--mac-text-secondary); display: flex; gap: 5px;
        }
        .path-segment { color: var(--mac-text-secondary); }
        .path-segment.current { color: var(--mac-text); font-weight: 500; }

        .file-list-container { flex: 1; overflow-y: auto; }
        .file-row {
            display: flex; align-items: center;
            padding: 8px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .file-row:nth-child(even) { background: rgba(255,255,255,0.02); }
        .file-row:hover { background: rgba(255,255,255,0.05); }

        .file-icon { width: 24px; margin-right: 10px; text-align: center; }
        .file-icon.folder { color: #0a84ff; }
        .file-icon.file { color: #98989d; }

        .file-name { flex: 1; font-size: 13px; }
        .file-meta { color: var(--mac-text-secondary); font-size: 12px; tabular-nums: true; }

        .empty-state {
            height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: var(--mac-text-secondary);
        }
        .empty-state i { font-size: 32px; margin-bottom: 16px; opacity: 0.2; }

        /* --- Modals (Transition wrapper for Vue) --- */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.2s; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }

        .sheet-enter-active, .sheet-leave-active { transition: transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .sheet-enter-from, .sheet-leave-to { transform: translateY(-20px); }

        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: flex; justify-content: center; padding-top: 60px;
            z-index: 2000;
        }

        .sheet {
            background: #2c2c2c; width: 400px;
            border-radius: 12px; padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            border: 1px solid rgba(0,0,0,0.3);
        }

        .sheet h3 { text-align: center; font-size: 15px; font-weight: 600; margin-bottom: 8px; }
        .sheet p.subtitle { text-align: center; font-size: 12px; color: var(--mac-text-secondary); margin-bottom: 20px; }

        .form-row { margin-bottom: 16px; }
        .form-row label { display: block; font-size: 12px; margin-bottom: 6px; font-weight: 500; }

        .mac-input, .mac-select {
            width: 100%; background: #1c1c1c;
            border: 1px solid #454545; border-radius: 6px;
            padding: 6px 8px; color: white; font-size: 13px;
        }
        .mac-input:focus, .mac-select:focus { outline: none; border-color: var(--mac-blue); box-shadow: 0 0 0 3px var(--mac-blue-dim); }

        .sheet-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }

        .mac-btn {
            padding: 4px 14px; border-radius: 6px; font-size: 13px;
            border: none; cursor: pointer; font-weight: 500;
        }
        .mac-btn.secondary { background: rgba(255,255,255,0.1); color: white; }
        .mac-btn.primary { background: var(--mac-blue); color: white; }

        /* --- Toast Transition --- */
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { transform: translateX(100%); opacity: 0; }

        .toast {
            position: fixed; top: 40px; right: 20px;
            background: rgba(40, 40, 40, 0.9); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 16px; border-radius: 8px;
            font-size: 13px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 10px; z-index: 3000;
        }
    </style>
</head>
<body>
<div class="titlebar-drag-region"></div>

<div id="app">
    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-header">Vaults</div>

                <div v-if="vaults.length === 0" style="padding: 10px; color: #666; font-size: 12px; text-align: center;">
                    No Vaults
                </div>

                <div v-for="vault in vaults"
                     :key="vault.id"
                     :class="['vault-item', { active: currentVaultId === vault.id }]"
                     @click="selectVault(vault.id)">
                    <i class="fa-solid fa-cube"></i>
                    <span style="flex:1; overflow:hidden; text-overflow:ellipsis;">{{ vault.id }}</span>
                    <div :class="['vault-status-dot', { mounted: vault.is_mounted }]"
                         :title="vault.is_mounted ? 'Mounted' : 'Unlocked'"></div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="icon-btn" @click="showModal('create')" title="Create Vault">
                    <i class="fa-solid fa-plus"></i>
                </button>
                <button class="icon-btn" @click="showModal('unlock')" title="Unlock Vault">
                    <i class="fa-solid fa-key"></i>
                </button>
            </div>
        </div>

        <div class="content">
            <div class="toolbar">
                <div class="toolbar-title">
                    <template v-if="currentVaultId">
                        <i class="fa-solid fa-box-archive" style="color:var(--mac-blue);"></i>
                        {{ currentVaultId }}
                    </template>
                    <span v-else>AxiomVault</span>
                </div>

                <div class="toolbar-actions" v-if="currentVaultId">
                    <button class="tool-btn" @click="createNewFile">
                        <i class="fa-regular fa-file"></i> New
                    </button>
                    <button class="tool-btn" @click="createNewFolder">
                        <i class="fa-solid fa-folder-plus"></i> Folder
                    </button>
                    <button class="tool-btn" @click="toggleMount">
                        <i class="fa-solid fa-hard-drive"></i> Mount
                    </button>
                    <button class="tool-btn" @click="lockVault" style="color: #ff453a;">
                        <i class="fa-solid fa-lock"></i> Lock
                    </button>
                </div>

                <div style="font-size: 11px; color: var(--mac-text-secondary);">
                    {{ fuseStatus }}
                </div>
            </div>

            <div v-if="!currentVaultId" class="empty-state">
                <i class="fa-solid fa-shield-halved"></i>
                <h3>No Vault Selected</h3>
                <p style="font-size: 13px;">Select a vault from the sidebar or create a new one.</p>
            </div>

            <div v-else style="display: flex; flex: 1; flex-direction: column;">
                <div class="path-bar">
                        <span v-for="(segment, index) in breadcrumbs" :key="index"
                              :class="['path-segment', { current: index === breadcrumbs.length - 1 }]">
                            <span v-if="index > 0" style="color:#666; margin:0 4px;">/</span>
                            {{ segment || 'Root' }}
                        </span>
                </div>

                <div class="file-list-container">
                    <div v-if="files.length === 0" class="empty-state" style="height: 200px;">
                        <p>Folder is empty</p>
                    </div>

                    <div v-if="currentPath !== '/'" class="file-row" @click="navigateUp">
                        <div class="file-icon folder"><i class="fa-solid fa-folder"></i></div>
                        <div class="file-name">..</div>
                    </div>

                    <div v-for="file in sortedFiles" :key="file.path" class="file-row" @click="handleItemClick(file)">
                        <div :class="['file-icon', file.is_directory ? 'folder' : 'file']">
                            <i :class="file.is_directory ? 'fa-solid fa-folder' : 'fa-regular fa-file'"></i>
                        </div>
                        <div class="file-name">{{ file.name }}</div>
                        <div class="file-meta">{{ file.size ? formatSize(file.size) : '--' }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <transition name="modal">
        <div v-if="activeModal" class="modal-backdrop" @click.self="closeModal">
            <transition name="sheet" appear>

                <div v-if="activeModal === 'create'" class="sheet">
                    <h3>Create New Vault</h3>
                    <p class="subtitle">Enter details for your new secure container.</p>
                    <div class="form-row">
                        <label>Vault Name</label>
                        <input type="text" class="mac-input" v-model="forms.create.name" placeholder="Documents">
                    </div>
                    <div class="form-row">
                        <label>Password</label>
                        <input type="password" class="mac-input" v-model="forms.create.password">
                    </div>
                    <div class="form-row">
                        <label>Verify</label>
                        <input type="password" class="mac-input" v-model="forms.create.confirm">
                    </div>
                    <div class="form-row">
                        <label>Provider</label>
                        <select class="mac-select" v-model="forms.create.provider">
                            <option value="memory">Local Memory</option>
                            <option value="gdrive">Google Drive</option>
                        </select>
                    </div>
                    <div class="sheet-footer">
                        <button class="mac-btn secondary" @click="closeModal">Cancel</button>
                        <button class="mac-btn primary" @click="createVault">Create</button>
                    </div>
                </div>

                <div v-else-if="activeModal === 'unlock'" class="sheet">
                    <h3>Unlock Vault</h3>
                    <p class="subtitle">Enter your credentials.</p>
                    <div class="form-row">
                        <label>Vault ID</label>
                        <input type="text" class="mac-input" v-model="forms.unlock.id" placeholder="Documents">
                    </div>
                    <div class="form-row">
                        <label>Password</label>
                        <input type="password" class="mac-input" v-model="forms.unlock.password">
                    </div>
                    <div class="sheet-footer">
                        <button class="mac-btn secondary" @click="closeModal">Cancel</button>
                        <button class="mac-btn primary" @click="unlockVault">Unlock</button>
                    </div>
                </div>

                <div v-else-if="activeModal === 'mount'" class="sheet">
                    <h3>Mount Volume</h3>
                    <p class="subtitle">Select a mount point.</p>
                    <div class="form-row">
                        <label>Mount Point</label>
                        <input type="text" class="mac-input" v-model="forms.mount.point" placeholder="/mnt/vault">
                    </div>
                    <div class="sheet-footer">
                        <button class="mac-btn secondary" @click="closeModal">Cancel</button>
                        <button class="mac-btn primary" @click="mountVault">Mount</button>
                    </div>
                </div>

            </transition>
        </div>
    </transition>

    <transition name="toast">
        <div v-if="notification.show" class="toast">
            <i :class="['fa-solid', notification.isError ? 'fa-circle-exclamation' : 'fa-circle-check']"
               :style="{ color: notification.isError ? '#ff453a' : '#0a84ff' }"></i>
            <span>{{ notification.message }}</span>
        </div>
    </transition>
</div>

<script type="module">
    // Wait for Tauri API to be ready
    async function waitForTauri(timeout = 5000) {
        const startTime = Date.now();
        while (!window.__TAURI__ || !window.__TAURI__.core) {
            if (Date.now() - startTime > timeout) {
                throw new Error('Tauri API not available after timeout');
            }
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        return window.__TAURI__.core;
    }

    try {
        console.log('Waiting for Tauri API...');
        const tauriCore = await waitForTauri();
        const { invoke } = tauriCore;
        console.log('Tauri API ready');

        console.log('Loading Vue...');
        const { createApp, ref, computed, onMounted } = await import('https://unpkg.com/vue@3/dist/vue.esm-browser.js');
        console.log('Vue loaded');

        const app = createApp({
        setup() {
            // State
            const fuseStatus = ref('Checking...');
            const vaults = ref([]);
            const currentVaultId = ref(null);
            const currentPath = ref('/');
            const files = ref([]);
            const activeModal = ref(null); // 'create', 'unlock', 'mount', or null

            const forms = ref({
                create: { name: '', password: '', confirm: '', provider: 'memory' },
                unlock: { id: '', password: '' },
                mount: { point: '' }
            });

            const notification = ref({ show: false, message: '', isError: false });

            // Computed
            const breadcrumbs = computed(() => currentPath.value.split('/'));

            const sortedFiles = computed(() => {
                return [...files.value].sort((a, b) => {
                    if (a.is_directory === b.is_directory) return a.name.localeCompare(b.name);
                    return a.is_directory ? -1 : 1;
                });
            });

            // Actions
            const showNotify = (msg, isError = false) => {
                notification.value = { show: true, message: msg, isError };
                setTimeout(() => notification.value.show = false, 3000);
            };

            const showModal = (type) => activeModal.value = type;
            const closeModal = () => activeModal.value = null;

            // API Calls
            const refreshVaults = async () => {
                try {
                    vaults.value = await invoke('list_vaults');
                } catch (e) {
                    showNotify('Failed to load vaults: ' + e, true);
                }
            };

            const refreshFiles = async () => {
                if (!currentVaultId.value) return;
                try {
                    files.value = await invoke('list_files', {
                        id: currentVaultId.value,
                        path: currentPath.value
                    });
                } catch (e) {
                    showNotify('Failed to list files: ' + e, true);
                }
            };

            const selectVault = async (id) => {
                currentVaultId.value = id;
                currentPath.value = '/';
                await refreshFiles();
            };

            // CRUD Operations
            const createVault = async () => {
                const f = forms.value.create;
                if (!f.name || !f.password) return showNotify('Fill all fields', true);
                if (f.password !== f.confirm) return showNotify('Passwords match error', true);

                try {
                    await invoke('create_vault', { id: f.name, password: f.password, providerType: f.provider });
                    closeModal();
                    showNotify('Vault created');
                    await refreshVaults();
                    selectVault(f.name);
                    // Reset form
                    forms.value.create = { name: '', password: '', confirm: '', provider: 'memory' };
                } catch (e) {
                    showNotify(e, true);
                }
            };

            const unlockVault = async () => {
                const f = forms.value.unlock;
                try {
                    await invoke('unlock_vault', { id: f.id, password: f.password });
                    closeModal();
                    showNotify('Unlocked');
                    await refreshVaults();
                    selectVault(f.id);
                    forms.value.unlock = { id: '', password: '' };
                } catch (e) {
                    showNotify(e, true);
                }
            };

            const lockVault = async () => {
                try {
                    await invoke('lock_vault', { id: currentVaultId.value });
                    currentVaultId.value = null;
                    showNotify('Locked');
                    await refreshVaults();
                } catch (e) {
                    showNotify(e, true);
                }
            };

            const toggleMount = () => {
                const v = vaults.value.find(v => v.id === currentVaultId.value);
                if (v && v.is_mounted) unmountVault();
                else showModal('mount');
            };

            const mountVault = async () => {
                try {
                    await invoke('mount_vault', { id: currentVaultId.value, mountPoint: forms.value.mount.point });
                    closeModal();
                    showNotify('Mounted');
                    await refreshVaults();
                    forms.value.mount.point = '';
                } catch (e) {
                    showNotify(e, true);
                }
            };

            const unmountVault = async () => {
                try {
                    await invoke('unmount_vault', { id: currentVaultId.value });
                    showNotify('Unmounted');
                    await refreshVaults();
                } catch (e) {
                    showNotify(e, true);
                }
            };

            // File System Ops
            const handleItemClick = (file) => {
                if (file.is_directory) {
                    currentPath.value = file.path;
                    refreshFiles();
                } else {
                    showNotify('Selected: ' + file.name);
                }
            };

            const navigateUp = () => {
                const parts = currentPath.value.split('/').filter(p => p);
                parts.pop();
                currentPath.value = parts.length === 0 ? '/' : '/' + parts.join('/');
                refreshFiles();
            };

            const createNewFile = async () => {
                const name = prompt('File name:');
                if (!name) return;
                const path = currentPath.value === '/' ? '/' + name : currentPath.value + '/' + name;
                try {
                    await invoke('create_file', { vaultId: currentVaultId.value, path, content: [] });
                    refreshFiles();
                } catch(e) { showNotify(e, true); }
            };

            const createNewFolder = async () => {
                const name = prompt('Folder name:');
                if (!name) return;
                const path = currentPath.value === '/' ? '/' + name : currentPath.value + '/' + name;
                try {
                    await invoke('create_directory', { vaultId: currentVaultId.value, path });
                    refreshFiles();
                } catch(e) { showNotify(e, true); }
            };

            // Utils
            const formatSize = (bytes) => {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / 1024 / 1024).toFixed(1) + ' MB';
            };

            // Init
            onMounted(async () => {
                try {
                    fuseStatus.value = await invoke('get_fuse_info');
                } catch { fuseStatus.value = 'Offline'; }
                await refreshVaults();
            });

            return {
                fuseStatus, vaults, currentVaultId, currentPath, files, breadcrumbs, sortedFiles,
                activeModal, forms, notification,
                showModal, closeModal, createVault, unlockVault, lockVault,
                toggleMount, mountVault, handleItemClick, navigateUp,
                createNewFile, createNewFolder, formatSize, selectVault
            };
        }
    });

        console.log('Mounting Vue app...');
        app.mount('#app');
        console.log('Vue app mounted successfully');
    } catch (error) {
        console.error('Failed to initialize application:', error);
        const errorHTML = `
            <div style="color: white; padding: 40px; text-align: center; font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                <h2 style="color: #ff453a; margin-bottom: 20px;">Initialization Error</h2>
                <p style="font-size: 14px; margin-bottom: 10px;">${error.message}</p>
                <p style="font-size: 12px; color: #98989d;">Check the browser console (F12) for more details.</p>
                <button onclick="location.reload()" style="margin-top: 20px; padding: 8px 16px; background: #0a84ff; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    Reload
                </button>
            </div>
        `;
        document.body.innerHTML = errorHTML;
    }
</script>
</body>
</html>
